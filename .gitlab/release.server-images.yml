#
# Сборка серверных docker образов
#
release-server-images:
  extends:
    - .rust-cache
    - .docker-dind-tls
  only:
    refs:
      - tags
  variables:
    version: $CI_COMMIT_TAG
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-x86_64-unknown-linux-musl:1.0.4
  stage: release
  cache:
    key: cargo-release-server-cache-v1
    paths:
      - server/target/
  script:
    - cd server
    - RUSTFLAGS="-Ctarget-cpu=haswell -Ctarget-feature=+avx2" cargo build --release --target x86_64-unknown-linux-musl
    - docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD registry.dev.cheetah.games/cheetah/
    - ln -s /runners-cache/target/ target
    - ./package-server-images.sh
