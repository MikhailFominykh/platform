#
# Сборка серверных docker образов
#
release-server-images:
  only:
    refs:
      - tags
  variables:
    version: $CI_COMMIT_TAG
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-x86_64-unknown-linux-musl:1.0.0
  stage: release
  script:
    - sleep 5
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.dev.cheetah.games/cheetah/
    - docker build . -f server/${directory}/Dockerfile -t registry.dev.cheetah.games/cheetah/platform/${image}:${version} --build-arg "RUSTFLAGS_ARG=-Ctarget-cpu=haswell -Ctarget-feature=+avx2"
    - docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD registry.dev.cheetah.games/cheetah/
    - docker push registry.dev.cheetah.games/cheetah/platform/${image}:${version}
  parallel:
    matrix:
      - directory: Accounts
        image: cheetah-accounts
      - directory: matches/Relay
        image: cheetah-matches-relay
      - directory: matches/StubMatchmaking
        image: cheetah-matches-stub-matchmaking
      - directory: matches/StubRegistry
        image: cheetah-matches-stub-registry
      - directory: matches/Factory
        image: cheetah-matches-factory
      - directory: matches/Registry
        image: cheetah-matches-registry
