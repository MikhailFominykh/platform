test-integration-build-docker-images:
  only:
    refs:
      - kviring
  variables:
    version: $CI_COMMIT_SHA
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-x86_64-unknown-linux-musl:1.0.0
  stage: test
  cache:
    key: cargo-release-server-cache
    paths:
      - server/target/
  script:
    - cd server
    - cargo fetcher --url file:///`pwd`/../.cache/crates/ --include-index sync
    - RUSTFLAGS="-Ctarget-cpu=haswell -Ctarget-feature=+avx2" cargo build --offline --release --target x86_64-unknown-linux-musl
    - docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD registry.dev.cheetah.games/cheetah/
    - ./package-server-images.sh


test-integration-build-relay-client:
  only:
    refs:
      - kviring
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-x86_64-unknown-linux-musl:1.0.0
  stage: test
  script:
    - cd server
    - cargo fetcher --url file:///`pwd`/../.cache/crates/ --include-index sync
    - cargo build --offline --manifest-path matches/Relay/Client/Cargo.toml --release
  artifacts:
    paths:
      - server/target/release/libcheetah_matches_relay_client.so
    expire_in: 1 day


test-intergration-update-kubernetes-release:
  only:
    refs:
      - kviring
  needs:
    - test-integration-build-docker-images
  variables:
    namespace: $CI_COMMIT_REF_SLUG
    version: $CI_COMMIT_SHA
  image: registry.dev.cheetah.games/cheetah/images/helm-builder:1.0.2
  stage: test
  script:
    - helm --kubeconfig=$kubeconfig uninstall ${namespace} -n ${namespace} || true
    - kubectl --kubeconfig=$kubeconfig  delete --namespace ${namespace} --all deployments,statefulsets,services,pods,pvc
    - sleep 20
    - cd hosting/charts/
    - tar -czf rooms-configuration.tgz -C ../../server/matches/Factory/example/ .
    - helm --kubeconfig=$kubeconfig  upgrade --debug --install ${namespace} -n ${namespace} Platform -f Platform/values-dev.yaml --set global.grpcDomain=${namespace}.stage.cheetah.games --set global.platformImageVersion=${version} --set global.roomsConfiguration=`cat rooms-configuration.tgz | openssl enc -A -base64`
    - sleep 10

test-integration-cleanup:
  only:
    refs:
      - kviring
  image: registry.dev.cheetah.games/cheetah/images/helm-builder:1.0.2
  stage: cleanup
  variables:
    namespace: $CI_COMMIT_REF_SLUG
    version: $CI_COMMIT_SHA
  script:
    - helm --kubeconfig=$kubeconfig  uninstall ${namespace} -n ${namespace}
    - kubectl --kubeconfig=$kubeconfig  delete --namespace ${namespace} --all deployments,statefulsets,services,pods,pvc
