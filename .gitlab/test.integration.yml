variables:
  namespace: $CI_COMMIT_REF_SLUG
  version: $CI_COMMIT_SHA
  UNITY_DIR: $CI_PROJECT_DIR/clients/Unity/

#
# Сборка docker image для сервисов сервера
#
build-server-images-for-integration-test:
  extends:
    - .rust-cache
    - .integration-branches
    - .docker-dind-tls
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-x86_64-unknown-linux-musl:1.0.8
  stage: test
  script:
    - cd server
    - RUSTFLAGS="-Ctarget-cpu=haswell -Ctarget-feature=+avx2" CARGO_INCREMENTAL=0 cargo build --release --target x86_64-unknown-linux-musl
    - docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD registry.dev.cheetah.games/cheetah/
    - ln -s /runners-cache/target/ target
    - ./package-server-images.sh

#
# Собираем  relay.so для Unity под Linux
#
build-relay-client-for-integration-test:
  extends:
    - .rust-cache
    - .integration-branches
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-x86_64-unknown-linux-gnu:1.0.2
  stage: test
  script:
    - source $HOME/.cargo/env
    - cd server
    - CARGO_INCREMENTAL=0 cargo build --manifest-path matches/Relay/Client/Cargo.toml --release
    - cp /runners-cache/target/release/libcheetah_matches_relay_client.so ../libcheetah_matches_relay_client.so
  artifacts:
    paths:
      - libcheetah_matches_relay_client.so
    expire_in: 1 day


#
# Развертываем сервер в kubernetes кластере
#
install-servers-to-kubernetes-for-integration-test:
  extends:
    - .rust-cache
    - .integration-branches
  needs:
    - build-server-images-for-integration-test
  image: registry.dev.cheetah.games/cheetah/images/helm-builder:1.1.5
  stage: test
  script:
    - helm --kubeconfig=$kubeconfig uninstall ${namespace} -n ${namespace} || true
    - kubectl --kubeconfig=$kubeconfig  delete --namespace ${namespace} --all deployments,statefulsets,services,pods,pvc
    - sleep 20
    - cd hosting/charts/
    - helm cheetah-config-creator ../example-config Platform/templates/
    - helm --kubeconfig=$kubeconfig  upgrade --debug --install ${namespace} -n ${namespace} Platform -f Platform/values-dev.yaml --set global.grpcDomain=${namespace}.stage.cheetah.games --set global.platformImageVersion=${version}
    - sleep 60

#
# Запускаем тесты в Unity с сервером в kubernetes
#
test-integration-run-unity-with-kubernetes:
  extends:
    - .rust-cache
    - .integration-branches
  needs:
    - install-servers-to-kubernetes-for-integration-test
    - build-relay-client-for-integration-test
  image: unityci/editor:2021.2.7f1-base-1.0.0
  variables:
    TEST_PLATFORM: playmode
    TESTING_TYPE: JUNIT
  before_script:
    - mkdir -p /root/.cache/unity3d
    - mkdir -p /root/.local/share/unity3d/Unity/
  script:
    - apt-get update && apt-get install -y default-jre libsaxonb-java
    - echo "${UNITY_LICENSE}" | tr -d '\r' > /root/.local/share/unity3d/Unity/Unity_lic.ulf
    - echo "{\"ServerHost\":\"${namespace}.stage.cheetah.games\"}" >  $UNITY_DIR/integration-test-config.json
    - chmod +x .gitlab/scripts/unity-test.sh
    - cp libcheetah_matches_relay_client.so clients/Unity/Packages/games.cheetah.matches.relay/x86_64/libcheetah_matches_relay_client.so
    - cd proto && ./generate-unity-grpc.sh && cd ../
    - TEST_PLATFORM=editmode .gitlab/scripts/unity-test.sh
    - TEST_PLATFORM=playmode .gitlab/scripts/unity-test.sh
  artifacts:
    when: always
    reports:
      junit:
        - $UNITY_DIR/editmode-junit-results.xml
        - $UNITY_DIR/playmode-junit-results.xml


#
# Запускаем тесты в Unity с сервером в docker
#
test-integration-run-unity-with-local-docker:
  extends:
    - .integration-branches
    - .docker-dind-no-tls
  needs:
    - build-server-images-for-integration-test
    - build-relay-client-for-integration-test
  image: registry.dev.cheetah.games/cheetah/images/unity-builder:1.0.0
  cache:
    key: "unity-integration-test"
    paths:
      - $UNITY_DIR/Library/
  before_script:
    - mkdir -p /root/.cache/unity3d
    - mkdir -p /root/.local/share/unity3d/Unity/
  script:
    - echo "${UNITY_LICENSE}" | tr -d '\r' > /root/.local/share/unity3d/Unity/Unity_lic.ulf
    - echo "{\"ServerImageVersion\":\"${version}\"}" >  $UNITY_DIR/integration-test-config.json
    - echo "{\"Login\":\"$CI_DEPLOY_USER\",\"Password\":\"$CI_DEPLOY_PASSWORD\"}" > $UNITY_DIR/cheetah-docker-registry.json
    - chmod +x .gitlab/scripts/unity-test.sh
    - cp libcheetah_matches_relay_client.so clients/Unity/Packages/games.cheetah.matches.relay/x86_64/libcheetah_matches_relay_client.so
    - cd proto && ./generate-unity-grpc.sh && cd ../
    - TEST_PLATFORM=editmode .gitlab/scripts/unity-test.sh
    - TEST_PLATFORM=playmode .gitlab/scripts/unity-test.sh
  artifacts:
    when: always
    reports:
      junit:
        - $UNITY_DIR/editmode-junit-results.xml
        - $UNITY_DIR/playmode-junit-results.xml



remove-kubernetes-release:
  extends:
    - .integration-branches
  image: registry.dev.cheetah.games/cheetah/images/helm-builder:1.0.2
  stage: cleanup
  variables:
    namespace: $CI_COMMIT_REF_SLUG
    version: $CI_COMMIT_SHA
  script:
    - helm --kubeconfig=$kubeconfig  uninstall ${namespace} -n ${namespace}
    - kubectl --kubeconfig=$kubeconfig  delete --namespace ${namespace} --all deployments,statefulsets,services,pods,pvc
