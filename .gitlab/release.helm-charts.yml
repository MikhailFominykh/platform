release-helm-charts:
  only:
    refs:
      - tags
  stage: release
  image: registry.dev.cheetah.games/cheetah/images/helm-builder:1.0.0
  variables:
    version: $CI_COMMIT_TAG
  script:
    - find . -name Chart.yaml | xargs -I {} sed -i.bak "s/999.999.999/$version/" {}
    - find . -name values.yaml | xargs -I {} sed -i.bak "s/999.999.999/$version/" {}
    - find . -name values.yaml | xargs -I {} sed -i.bak "s/IMAGES_VERSION/$version/" {}
    - cd hosting/charts/Platform
    - helm dependency update .
    - helm package .
    - helm repo add --username $CI_DEPLOY_USER --password $CI_DEPLOY_PASSWORD repo "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api"
    - helm cm-push /builds/cheetah/platform/hosting/charts/Platform/platform-$version.tgz repo