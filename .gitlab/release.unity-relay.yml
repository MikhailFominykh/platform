#
# Сборка клиентской библиотеки для relay
#
build-relay-library-for-linux:
  extends: .rust-cache
  only:
    refs:
      - tags
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-x86_64-unknown-linux-musl:1.0.3
  stage: release
  script:
    - cd server
    - cargo build  --manifest-path matches/Relay/Client/Cargo.toml --release
    - cp /runners-cache/target/release/libcheetah_matches_relay_client.so ../libcheetah_matches_relay_client.so.linux
  artifacts:
    paths:
      - libcheetah_matches_relay_client.so.linux
    expire_in: 1 day

build-relay-library-for-android-armv7:
  extends: .rust-cache
  only:
    refs:
      - tags
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-armv7-linux-androideabi:1.0.0
  stage: release
  script:
    - export PATH=$PATH:/.cargo/bin/
    - cd server
    - /.cargo/bin/cargo build  --manifest-path matches/Relay/Client/Cargo.toml --target armv7-linux-androideabi --release
    - cp /runners-cache/target/armv7-linux-androideabi/release/libcheetah_matches_relay_client.so ../libcheetah_matches_relay_client.so.armv7
  artifacts:
    paths:
      - libcheetah_matches_relay_client.so.armv7
    expire_in: 1 day

build-relay-library-for-android-aarch64:
  extends: .rust-cache
  only:
    refs:
      - tags
  image: registry.dev.cheetah.games/cheetah/images/rust-builder-aarch64-linux-android:1.0.0
  stage: release
  script:
    - export PATH=$PATH:/.cargo/bin/
    - cd server
    - /.cargo/bin/cargo build  --manifest-path matches/Relay/Client/Cargo.toml --target aarch64-linux-android --release
    - cp /runners-cache/target/aarch64-linux-android/release/libcheetah_matches_relay_client.so ../libcheetah_matches_relay_client.so.aarch64
  artifacts:
    paths:
      - libcheetah_matches_relay_client.so.aarch64
    expire_in: 1 day

build-relay-library-for-windows:
  only:
    refs:
      - tags
  stage: release
  tags:
    - win
  script:
    - curl https://win.rustup.rs/x86_64 --output rustup-init.exe
    - .\rustup-init.exe -y
    - cd server
    - $env:PATH+=";$env:USERPROFILE\.cargo\bin"
    - rustup.exe toolchain install stable-x86_64-pc-windows-msvc
    - rustup.exe default stable-x86_64-pc-windows-msvc
    - cargo.exe build --manifest-path matches/Relay/Client/Cargo.toml
    - cd ../
  artifacts:
    paths:
      - server/target/debug/cheetah_matches_relay_client.dll
      - server/target/debug/cheetah_matches_relay_client.pdb
    expire_in: 1 day

build-relay-library-for-macos:
  only:
    refs:
      - tags
  stage: release
  tags:
    - macos
  script:
    - cd server
    - cargo build --manifest-path matches/Relay/Client/Cargo.toml --release
    - cd ../
  artifacts:
    paths:
      - server/target/release/libcheetah_matches_relay_client.dylib
    expire_in: 1 day

build-relay-library-for-ios:
  only:
    refs:
      - tags
  stage: release
  tags:
    - macos
  script:
    - cd server
    - cargo build --manifest-path matches/Relay/Client/Cargo.toml --release --target aarch64-apple-ios
    - cd ../
  artifacts:
    paths:
      - server/target/aarch64-apple-ios/release/libcheetah_matches_relay_client.a
    expire_in: 1 day

release-unity-relay:
  only:
    refs:
      - tags
  stage: release
  image: node:17.7.2-stretch-slim
  dependencies:
    - build-relay-library-for-linux
    - build-relay-library-for-android-armv7
    - build-relay-library-for-android-aarch64
    - build-relay-library-for-windows
    - build-relay-library-for-macos
    - build-relay-library-for-ios
  needs:
    - build-relay-library-for-linux
    - build-relay-library-for-android-armv7
    - build-relay-library-for-android-aarch64
    - build-relay-library-for-windows
    - build-relay-library-for-macos
    - build-relay-library-for-ios
  variables:
    version: $CI_COMMIT_TAG
  script:
    - cp libcheetah_matches_relay_client.so.linux clients/Unity/Packages/games.cheetah.matches.relay/x86_64/libcheetah_matches_relay_client.so
    - cp libcheetah_matches_relay_client.so.armv7 clients/Unity/Packages/games.cheetah.matches.relay/Android/armv7/libcheetah_matches_relay_client.so
    - cp libcheetah_matches_relay_client.so.aarch64 clients/Unity/Packages/games.cheetah.matches.relay/Android/aarch64/libcheetah_matches_relay_client.so
    - cp server/target/debug/cheetah_matches_relay_client.dll clients/Unity/Packages/games.cheetah.matches.relay/x86_64/cheetah_matches_relay_client.dll
    - cp server/target/debug/cheetah_matches_relay_client.pdb clients/Unity/Packages/games.cheetah.matches.relay/x86_64/cheetah_matches_relay_client.pdb
    - cp server/target/release/libcheetah_matches_relay_client.dylib clients/Unity/Packages/games.cheetah.matches.relay/x86_64/libcheetah_matches_relay_client.bundle
    - cp server/target/aarch64-apple-ios/release/libcheetah_matches_relay_client.a clients/Unity/Packages/games.cheetah.matches.relay/iOS/libcheetah_matches_relay_client.a
    - sed -i.bak "s/999.999.999/${version}/" clients/Unity/Packages/games.cheetah.matches.relay/package.json
    - echo "${CI_API_V4_URL#https?}/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=\${CI_JOB_TOKEN}" > .npmrc
    - npm publish clients/Unity/Packages/games.cheetah.matches.relay/