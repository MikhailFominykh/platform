
### Жизненный цикл клиента

- создание
- отправка/получение данных
- удаление

При дисконнекте клиента он не удаляется из реестра, необходимо его удалить самостоятельно.

### Загрузка комнаты

При создании клиента он автоматически соединяется с сервером, но объекты ему не загружаются и команды не присылаются.
Но в тоже время клиент может посылать команды и они будут обработаны сервером.

Для загрузки всех существующих объектов необходимо вызывать команду AttachToRoom. При этом клиенту загрузятся все объекты
комнаты и будет разрешено получение обновлений. Следует понимать что загрузятся все объекта, даже те которые созданы
данным клиентом, тем самым вызвав данную команду после рестарта приложения можно восстановить все серверные данные.

### Контексты в API

В вызовах API некоторые аргументы берутся из контекста:

- клиент
- тип канала отправки

Клиент устанавливается в контекст после создания и может быть изменен, однако обычно это не требуется,
так как клиент в игре один. Исключение - тесты и отладка.

Тип канала отправки по-умолчанию - надежный, с сохранением последовательности по группе с идентификатором 0.

### Восстановление соединения при аварийном завершении приложения

Если приложение завершилось аварийно, то при рестарте можно восстановить соединение.
Для этого в процессе работы приложение должно сохранять текущий frameId в постоянное
хранилище, а при рестарте создать клиента с сохраненным frameId, добавив к нему смещение
в 200*Ps, где Ps период сохранения frameId в секундах.
Для получения frameId используется метод:

```c#
ClientCommands.GetStatistics(out var statistics);
```

Внимание - на данный момент сервер ждет клиента 10 секунд,  после этого восстановление
соединения не возможно, также сервер удалит все пользовательские объекты.
Повтороное соединение в production режиме к такому серверу запрещено.
Однако в режиме автосоздания пользователей будет создан новый пользователь и соединение будет возможно.



### Общий принцип работы с командами

#### Прием
Для принятия команды необходимо один раз для клиента зарегистрировать callback функцию, данная функция вызывается
для обработки команды с сервера. Для разных типов команд есть разные callback функции и их надо регистрировать отдельно.
Для обработки команд необходимо вызывать функцию recive, которая вызовет callback функции обработчик команд для принятых команд.

#### Отправка
Отправка команды происходит после вызова соответствующей функции.

#### Ограничение на размер
- бинарные данные - 255 байт на поле
- объект - 255 полей на тип.

### Использование делегатов в нативных функциях клиента

- Делегаты передаваемые в нативные функции не должны выбрасывать исключения,
  так как это приведет к зависанию клиента на втором вызове.
  Rust не умеет их обрабатывать, поэтому не снимет блокировки и не освободит память.

- Также нельзя из делегатов вызывать другие нативные функции,
  это приведет к аналогичным проблемам.

- Делегаты могут ссылаться только на статичные методы, с аннотацией \[MonoPInvokeCallback(typeof(..))\].
  Иначе не будет работать IL2CPP.

- Нельзя использовать API из async, так как обработчик события может быть прерван, что может привести к повторному вызову API.
  А это всегда приводит к зависанию клиента.


### Дополнительная документация
Смотрите тесты.