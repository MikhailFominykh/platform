# Хранение пользовательских аналитических событий

## Требования

- надежное хранение пользовательских событий - пары ключ/значения
- хранения логов с клиента
- возможно перегрузки в другое хранилище в дальнейшем
- анализ событий, пока в минимальном варианте, события по сессии, события по-пользователю

## Реализация

### Loki 
Так как уже используется Loki, то его вполне можно использовать для работы с событиями

"+"
- простой и надежный
- экономное хранение данных

"-"
- нет возможности сложных запросов (нет join)
- хранение event-ов, нет таблиц

### Архитектура

GRPC сервис для приема и сохранения событий от клиента. Не требует авторизации пользователей. Сохранение синхронное, 
пока событие не ушло в Loki, запрос не завершается.

#### Надежность

Если клиент не смог отправить событие - он его сохраняет в отдельный файл и периодические пытается отправить все 
сохраненные события. После успешной отправки файл удаляется. При старте клиент также смотрит на наличие файлов и 
отправляет не отправленные события. Такой подход служит двум целям - сохранению события если Loki/gRPC сервис не 
отвечает и если на устройстве пользователя нет интернета.

Все повторно отправленные события тагируются меткой system_repeat_send = true. Так как время отправления такого 
события не совпадает с его созданием, то необходимо добавить поле create_event_time с указанием времени создания 
события.


#### API на клиенте

- Разделяем методы для отправки событий и для отправки сообщений об ошибке.
- Метки по-умолчанию, которые прикрепляются к каждому сообщению
  - идентификатор сессии
  - идентификатор пользователя (если есть)









