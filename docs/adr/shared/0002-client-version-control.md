# Поддержка разных версий клиента


## Варианты

Под игровым процессом здесь понимается не только боевка, но и другие активности - например чат с другом в лобби.

### Вариант 1
При выходе новой версии даем пользователю сутки (для примера) для обновления - например, обновляем при новом запуске 
клиента, тем самым не прерываем игровой процесс. Или предлагаем обновится при выходе из игры (не из битвы). В общем у игрока есть 
опции когда он может обновится.
#### +
- не заставляем игроков прерывать игру и обновляться
- обновление можно сделать при следующем запуске игры
- не всегда во всех сторах сразу же появляется обновление, у разных клиентов может быть по-разному, поэтому неплохо 
  бы дождаться когда обновление будет у конкретного игрока;
#### - 
- меньше игроков для подбора матчей (особенно в начале - будет мало игроков для новой версии)
- у разных игроков будет разная функциональность в одно и то же время, например разные версии чата должны работать 
  одновременно, а в новой версии могут быть новые возможности. 


### Вариант 2
Доигрывает битву, после выхода из битвы есть оповещение о новой версии, пока не обновил - играть дальше нельзя.
Если в это время был не в битве и при запуске клиента - ему также выводится оповещение и начинается обновление.
#### +
- новая версия быстро распространяется среди игроков;
- можно доиграть текущий матч;
- все игроки всегда на новой версии - больше игроков для подбора битв;
#### -
- игрок прерывается от игрового процесса, при этом возможно на долго, так как через стор не всегда можно обновится 
  за несколько секунд;



### Вариант 3
Делаем комбинированную схему - для некоторых исправлений используем вариант 2, к таким обновлениям относятся 
исправление критичных ошибок, глобальный рефакторинг кода. Все остальные исправления - по варианту 1, с указанием для MM могут ли встречаться старые клиенты с новыми в одной битве.

#### "+"
- больше радости игрокам на мой взгляд, чаще всего его не прерывают в середине игры (например, когда он активно 
  переписывается и с другом в чате)
- позволяет более часто выкатывать релизы с пониманием того, что это не сильно раздражает игроков.

#### "-"
- чуть больше нагрузка на разработчиков, в основном для понимания будет ли работать новая версия вместе со старой 
  (для выбора 1 или 2 варианта)
- нагрузка на тестирование, необходимо будет протестировать два варианта (хотя и варианте 2 у нас есть некий 
  промежуток времени когда работают две версии клиентов)

## Реализация

Пока больше для варианта 2, но в целом подходит и для 1,3.

- создаем GRPC сервис, который будет сообщать клиенту список разрешенных версий, как только версии клиента не будет в
  списке - то клиент должен обновится (после завершения битвы);
- в MM в методе запроса новой битвы также передаем версию клиента, для того чтобы исключить гонки - когда relay сервера
  уже новые, а клиент не получил обновленный список версий;
- GRPC сервисы должны поддерживать несколько версий, так как мы сразу не запрещаем играть со старых клиентов, это можно
  сделать или разными URL в ingress контроллерах или разными названиями методов.
- Relay сервисы делятся по версиям клиентов и это учитывается в MM.

### Первая версия

С учетом того что MM по-сути фейковый, а до плавных обновлений серверных сервисов еще далеко (тут в основном devops
задача, с поддержкой разных типов релизов), то пока запрещаем играть клиентам старых версий. Однако делаем это методами,
которые будут работать в следующих версиях.

#### Реализация

На сервере - grpc сервис, данные из ConfigMap (с автообновлением)
На клиенте два метода - первый проверить разрешена ли версия клиента, второй - периодическая проверка на наличия
разрешения.

Данные храним в ConfigMap, обновление только с выводом релиза. Пока это самый простой способ, другие варианты сложнее,
например https сервис + curl запрос или админка.
